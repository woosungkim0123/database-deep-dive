# 특수 인덱스

## 공간 정보 인덱스

### 2D

전통적인 2차원 지도 데이터를 위한 인덱스로, 평면상의 지점을 인덱싱할 수 있습니다. 이를 통해 지도상의 객체들 사이의 거리 계산, 범위 쿼리 등을 수행할 수 있습니다.

### 2DSphere

지구와 같은 구형 모델을 사용하여 공간 데이터를 인덱싱하는 방법입니다. 위도와 경도를 이용하여 지구상의 위치를 나타내며, 이를 통해 실제 지구의 곡률을 고려한 쿼리를 실행할 수 있습니다. 

<br>

## 텍스트 인덱스

텍스트 인덱스는 텍스트 기반 검색을 가능하게 하는 인덱스입니다.

### 특징

1. 텍스트를 빠르게 검색할 수 있습니다.


2. 형태소 분석을 통하여 불필요한 단어를 제거하고 검색합니다.
    - "human is animals"에서 "is"를 제거하고 "human animals"로 검색합니다.


3. 각 필드 별로 검색 가중치를 부여할 수 있습니다.

    ```shell
    db.articles.createIndex({"title" : "text", "body" : "text"}, {"weights" : {"title" : 3, "body" : 1}})
    ```

4. 여러 언어를 지원합니다. 그러나 한국어는 지원하지 않습니다.

위 특징처럼 일반적인 검색 엔진 요구 사항을 지원하지만 검색 엔진 수준의 유사어 검색과 같은 고급 기능은 제공하지 않습니다.

### 와일드 카드 인덱스 사용

만약 컬렉션 도큐먼트에 포함되는 필드를 모르는 경우 모든 문자열 필드에 전문 인덱스를 생성할 수도 있습니다. 

모든 최상위 문자열 필드를 인덱싱 할 뿐만 아니라 내장 도큐먼트와 배열에서 문자열 필드를 검색합니다.

```shell
db.articles.createIndex({"$**" : "text"})
```

### 검색 기능

`$text` 연산자를 사용하여 텍스트 검색을 수행할 수 있습니다.

`$text`는 공백과 구두점을 구분 기호로 사용해 검색 문자열을 토큰화하며 모든 토큰은 OR 연산자로 연결됩니다.

```shell
db.articles.find({$text: {$search: "mongodb third edition"}})
```

해당 쿼리는 "mongodb" 또는 "third" 또는 "edition" 중 하나라도 포함하는 도큐먼트를 반환합니다.

필수로 포함해야하는 단어나 구문을 ""로 감싸서 검색하게 되면 정확한 구문 검색을 할 수 있습니다.

```shell
db.articles.find({$text: {$search: '"mongodb" "third edition"'}})
```

해당 쿼리는 "mongodb"와 "third edition"이 모두 포함된 도큐먼트를 반환합니다.

> $search 옵션 내에서 주어진 단어나 구문에 대해 기본적으로 OR 조건을 적용합니다. 그러나, 정확한 구문 검색을 사용하면 어느 정도 AND 조건을 구현할 수 있습니다.   
> 그러나 텍스트 검색에서는 직접적으로 AND와 OR 조건을 혼합해 사용하는 것이 제한적입니다.

특정 단어를 제외하고 검색할 때는 단어 앞에 '-'를 추가합니다.

```shell
db.articles.find({$text: {$search: 'mongodb -second'}})
```

### 주의 사항

MongoDB의 텍스트 인덱스는 유연하고 강력한 텍스트 검색 기능을 제공하지만 인덱스의 크기와 스토리지 사용량, 그리고 지원하는 언어에 대한 한계를 고려하여 사용해야 합니다.

<br>

## 제한 컬렉션

MongoDB의 컬렉션은 일반적으로 동적이지만 제한 컬렉션은 미리 생성되어있고 크기가 고정되어있습니다.

제한 컬렉션은 원형 큐처럼 동작하여 가득 찬 컬렉션에 입력을 시도하면 가장 오래된 문서가 지워지고 새로운 문서가 그 자리를 차지합니다.

기본적인 컬렉션 접근 방식과 달리 제한 컬렉션은 데이터가 디스크의 고정된 영역에 순서대로 기록됩니다. 
따라서 회전 디스크에서 쓰기를 다소 빠르게 수행할 수 있으며 전용 디스크가 있는 경우에는 더욱 빠릅니다.

### 권장 사항

일반적으로 TTL 인덱스가 더 나은 성능을 발휘하여 제한 컬렉션보다 권장됩니다.

TTL 인덱스는 날짜 유형 필드 값과 인덱스의 TTL 값을 기반으로 일반 컬렉션에서 데이터가 만료되고 제거됩니다.

제한 컬렉션은 유연성이 부족하지만 로깅에는 나름 유용합니다.

> 제한 컬렉션은 샤딩될 수 없습니다. 제한 컬렉션에서 도큐먼트 크기가 갱신이나 대체로 인해 변경되면 작업이 실패합니다.

### 제한 컬렉션 생성

10만 바이트 고정 크기로 제한 컬렉션을 생성해보겠습니다.

```shell
db.createCollection("log", {capped: true, size: 100000}) 
```

max를 지정하여 최대 도큐먼트 개수를 제한할 수도 있습니다. 최근 뉴스 기사 10개를 보관하거나 사용자 도큐먼트를 100개로 제한할 수 있습니다.

```shell
db.createCollection("log", {capped: true, size: 100000, max: 100})
```

기존 일반 컬렉션을 제한 컬렉션으로 변환할 수 도 있습니다. 

```shell
db.runCommand({convertToCapped: "news", size: 100000})
```

제한 컬렉션을 일반 컬렉션으로 변환하는 방법은 없습니다.

<br>

### 꼬리를 무는 커서

꼬리를 무는 커서는 결과를 모두 꺼낸 후에도 종료되지 않는 특수한 형태의 커서로 `tail -f` 명령어와 유사하게 결과를 지속적으로 꺼내는 기능을 수행합니다.

커서는 결과를 다 꺼내도 종료되지 않으므로 컬렉션에 데이터가 추가되면 새로운 결과를 바로 꺼낼 수 있습니다. 

커서는 시간이 초과되거나 누군가 쿼리 작업을 중지할 때까지 결과를 처리하거나 다른 결과가 도착하기를 기다립니다.

일반 컬렉션에서는 입력 순서가 추적되지 않기 때문에 제한 컬렉션에만 사용합니다.

> 스트림 변경은 꼬리 무는 커서보다 훨씬 많은 제어와 구성을 제공하고 일반 컬렉션에서도 작동하여 권장됩니다.

<br>

## TTL 인덱스

오래된 순 삭제 시스템을 더 유연하게 만들기 위해서는 제한 컬렉션보다는 TTL 인덱스를 이용해서 각 문서에 유효 시간을 설정할 수 있습니다.

문서는 미리 설정한 유효 시간이 지나면 자동으로 삭제됩니다.

TTL 인덱스는 주로 데이터가 일정 시간 동안만 유효하거나 필요한 경우에 유용하게 사용됩니다. 
예를 들어, 사용자의 세션 정보, 일시적인 이벤트 로그, 캐시된 데이터와 같은 정보들이 이에 해당합니다.

```shell
db.logs.createIndex({lastUpdated: 1}, {expireAfterSeconds: 60 * 60 * 24}) 
```

MongoDB는 TTL 인덱스를 매분마다 청소하므로 초 단위로 신경 쓸 필요는 없습니다.

`collMod` 명령어를 이용해 만료시간을 변경할 수 있습니다.

```shell
db.runCommand({collMod: "logs", index: {keyPattern: {lastUpdated: 1}, expireAfterSeconds: 60 * 60 * 24 * 7}})
```

<br>

## GridFS로 파일 저장하기

GridFS는 MongoDB에서 대용량 파일을 저장하고 관리하기 위해 설계된 파일 시스템입니다. 
일반적으로 MongoDB 문서의 최대 크기는 16MB로 제한되어 있지만, GridFS를 사용하면 이 한계를 넘어서는 크기의 파일들을 저장할 수 있습니다. 

GridFS는 큰 파일을 여러 개의 작은 청크(chunk), 즉 조각으로 나누어 데이터베이스에 저장합니다.

### GridFS 작동 방식

- 분할 저장: GridFS는 파일을 255KB 크기의 청크로 나누고, 이 청크들을 MongoDB의 컬렉션에 분산하여 저장합니다. 
이를 통해 매우 큰 파일도 효율적으로 관리할 수 있습니다.

- 두 가지 주요 컬렉션: GridFS는 파일을 저장할 때 두 가지 컬렉션을 사용합니다.
  - chunks 컬렉션: 파일의 실제 데이터를 저장하는 청크를 포함합니다.
  - files 컬렉션: 파일의 메타데이터(예: 파일 이름, 크기, 청크 개수, 업로드 시간 등)를 저장합니다.

### GridFS 사용 시나리오
  
- 대용량 파일 저장: 비디오, 이미지, 오디오 파일과 같이 큰 이진 데이터를 저장할 때 사용됩니다.
- 대용량 데이터 스트리밍: 큰 파일을 청크로 나누어 저장하므로, 사용자는 파일의 일부만 요청하거나 순차적으로 데이터를 스트리밍할 수 있습니다.
- 대용량 데이터의 효율적 관리: MongoDB의 인덱싱, 쿼리, 복제 등의 기능을 활용하여 대용량 파일을 효율적으로 관리할 수 있습니다.
  
### 장점
  
- GridFS는 MongoDB의 분산 데이터베이스 시스템을 활용해 큰 파일을 쉽게 저장하고 관리할 수 있도록 해줍니다.
- 파일의 청크화를 통해 대용량 파일에 대한 빠른 액세스 및 효율적인 스토리지 관리가 가능합니다.

### 단점

- 성능이 파일 시스템에서 파일을 읽는 것보다 떨어질 수 있습니다.
- 문서를 수정하려면 문서 전체를 삭제하고 다시 저장하는 방법밖에 없습니다. MongoDB는 파일을 여러개의 문서로 저장하므로 한 파일의 모든 청크에 동시에 락을 걸 수 없습니다.

### 결론

GridFS는 큰 변화가 없고 순차적인 방식으로 접근하려는 대용량 파일을 저장할 때 최선의 선택입니다.
