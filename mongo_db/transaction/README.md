# 트랜잭션

## 트랜잭션 소개

### 개념

트랜잭션은 데이터베이스에서 수행하는 한 개 이상의 읽기(read)나 쓰기(write) 작업을 포함하는 논리적인 작업 단위를 말합니다. 

간단히 말해, 트랜잭션은 데이터베이스 내에서 실행되는 하나의 완전한 작업 과정을 의미하며, 이 과정은 여러 단계의 작업을 포함할 수 있습니다.

### 목적

트랜잭션의 핵심 목적은 데이터의 일관성과 안정성을 보장하는 것입니다. 

트랜잭션이 성공적으로 완료되면 (즉, 커밋되면), 트랜잭션에 포함된 모든 작업이 데이터베이스에 영구적으로 반영됩니다. 
반면, 트랜잭션 중에 문제가 발생하거나 실패하면 (롤백되면), 트랜잭션의 시작 이전 상태로 데이터베이스를 복원함으로써, 트랜잭션의 실행 도중에 일어난 모든 변경사항이 취소됩니다.

트랜잭션의 가장 중요한 특징은 작업이 성공하든 실패하든 부분적으로는 완료되지 않는다는 것입니다.

<br>

## ACID 속성

트랜잭션이 '진정한' 트랜잭션으로 간주되기 위해서는 ACID 속성을 만족해야 합니다.

### Atomicity (원자성)

트랜잭션 내의 모든 작업은 하나의 단위로 간주됩니다.

원자성은 트랜잭션 내 모든 작업이 적용되거나 아무 작업도 적용되지 않도록 합니다. (커밋 or 롤백)

### Consistency (일관성)

트랜잭션이 완료되면 데이터베이스는 논리적으로 일관되고 정상적인 상태를 유지한다는 것을 의미합니다.

즉, 트랜잭션이 성공적으로 완료되면 데이터베이스는 무결한 상태가 보장된다는 것입니다.

> 더 쉽게 말하면, 트랜잭션이 끝나면 그 상태가 지금 정상적이니까 믿고 써도 된다는 것입니다.

### Isolation (독립성, 고립성, 격리)

여러 트랜잭션이 동시에 실행되더라도, 각 트랜잭션은 다른 트랜잭션의 작업에 영향을 받지 않는 것을 의미합니다.

### Durability (지속성, 영속성)

트랜잭션이 일단 커밋되면, 그 결과는 시스템의 장애가 발생하더라도 유지된다는 것을 의미합니다. 즉, 한 번 저장된 데이터는 영구적으로 보존됩니다.

**트랜잭션은 데이터베이스 시스템에서 데이터의 안전성과 정확성을 유지하기 위한 중요한 메커니즘입니다.**

<br>

## 트랜잭션 사용법

MongoDB는 트랜잭션을 사용하는 두가지 방법, `코어 API`와 `콜백 API`를 제공합니다.

### 논리 세션

두 API 모두 트랜잭션에서 사용할 논리 세션을 시작해야하며, 트랜잭션의 작업이 특정 논리 세션과 연결되어야 합니다.

> "논리 세션"은 트랜잭션이 데이터베이스에 대해 수행하는 일련의 연산들이 동일한 사용자 또는 프로세스에 의해 실행되고 있음을 보장합니다.

> 트랜잭션 작업이 특정 논리 세션과 연결되어야 한다는 것은 각 트랜잭션이 실행되는 동안 해당 트랜잭션의 모든 작업이 동일한 세션, 즉 동일한 연결 또는 트랜잭션 컨텍스트 내에서 발생해야 함을 의미합니다.   
> 이렇게 함으로써, 트랜잭션 내의 모든 데이터 변경 사항은 그 트랜잭션이 커밋되거나 롤백될 때까지 일관되고 분리된 상태를 유지합니다.

**자세히 들어가기**

MongoDB에서 `논리 세션`은 커피숍에서 주문할 때 사용하는 주문 번호와 유사합니다. 주문 번호를 받으면 그 번호로 주문이 무엇인지, 언제 주문했는지를 알 수 있습니다. 

MongoDB의 논리 세션도 이와 비슷하게, 데이터베이스 안에서 여러분이 하는 일들(데이터를 추가하거나 수정하는 등의 작업)을 추적하고 정리하는 데 도움을 줍니다.

`논리 세션`은 트랜잭션(또는 쿼리)들이 그룹화되어 실행되는 논리적인 작업의 단위입니다. 이는 클라이언트가 MongoDB 서버에 요청을 할 때, 해당 요청들이 어떤 순서로, 어떤 관계로 실행되어야 하는지를 정의합니다.

`서버 세션`은 이러한 논리 세션의 구현을 담당합니다. 즉, `서버 세션`은 `논리 세션`에 속한 트랜잭션들이 데이터베이스 서버 내에서 어떻게 처리될지를 실제로 관리하고 실행하는 역할을 합니다.

재시도 가능한 쓰기와 인과적 일관성은 이러한 세션을 사용하는 두가지 주요 기능입니다.

`재시도 가능한 쓰기`는 네트워크 오류나 기타 일시적인 문제로 인해 실패한 쓰기 작업을 클라이언트가 안전하게 재시도할 수 있도록 합니다.
MongoDB는 논리 세션을 사용하여 이전에 수행된 쓰기 작업을 추적하므로, 클라이언트가 동일한 작업을 안전하게 재시도할 수 있게 합니다.

`인과적 일관성`은 일련의 사건들이 원인과 결과의 순서대로 일어나야 한다는 개념입니다.

예를 들어, 여러분이 소셜 미디어에 글을 올리고, 누군가가 그 글에 댓글을 달았다면, 이 댓글은 여러분의 글이 먼저 올라간 후에 나타나야 합니다. 
만약 댓글이 먼저 나타나고, 그 다음에 글이 나타난다면, 이는 인과적 일관성이 깨진 것입니다.

MongoDB에서 인과적 일관성을 사용하면, 작업의 순서에 따라 데이터가 처리되도록 보장할 수 있습니다.

즉, 특정 작업의 결과가 다음 작업에 영향을 줄 수 있도록, 작업들이 발생한 순서대로 처리되고, 이 순서가 유지됩니다. 

이를 통해 데이터베이스 상의 작업들이 논리적으로 일관된 순서로 발생하고, 사용자가 예상한 대로 데이터가 변경되거나 조회되도록 보장합니다.

### 코어 API

코어 API는 대부분의 오류에 재시도 로직을 제공하지 않으며 개발자가 작업에 대한 로직, 트랜잭션 커밋 함수, 필요한 재시도 및 오류 로직을 직접 작성해야 합니다.

### 콜백 API

트랜잭션 사용에 권장되는 방법으로 트랜잭션 시작, 커밋, 롤백 및 재시도 로직 등 많은 부분을 단일 함수로 제공합니다.



