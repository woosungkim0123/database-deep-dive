# 시스템 변수

## 클린 셧다운

MYSQL 서버에서 트랜잭션이 정상적으로 커밋되어도 데이터 파일에 변경된 내용이 기록되지 않고 로그 파일(리두 로그)에만 기록되어 있는 경우가 있습니다.

서버가 재시작해도 해당 상태를 유지하는 경우도 있습니다. 특히 사용량이 많은 서버에서는 이러한 현상이 발생할 가능성이 높습니다.

이런 현상을 방지하기 위해 mysql 서버가 종료될 때 모든 커밋된 내용을 데이터 파일에 기록하고 종료하게 할 수 있습니다.

```shell
SET GLOBAL innodb_fast_shutdown = 0; # mysql 서버 옵션 변경
```

모든 커밋된 데이터를 데이터 파일에 적용하고 종료하는 것을 `클린 셧다운(Clean shutdown)`이라고 합니다.

클린 셧다운으로 종료되면 재시작시 별도의 트랜잭션 복구 과정을 진행하지 않기 때문에 서버가 빠르게 시작됩니다.

> 참고  
> 
> 서버가 시작되거나 종료될 때 MYSQL 서버(innoDB 스토리지 엔진)의 버퍼 풀 내용을 백업하고 복구하는 과정이 내부적으로 실행됩니다.
> 실제 버퍼 풀의 내용의 백업이 아닌 버퍼 풀에 적재된 데이터 파일의 데이터 페이지에 대한 메타 정보를 백업하기 때문에 용량은 크지 않고 빠르게 완료됩니다.
> 하지만 서버가 시작될 때는 디스크에서 데이터 파일들을 모두 읽어서 적재해야 하므로 시간이 오래 걸립니다.
> 만약 서버 시작 시간이 오래 걸린다면 버퍼 풀의 내용을 복구하고 있는지 확인 해보는 것이 좋습니다.

<br>

## 개념

서버가 시작되면서 설정파일을 읽어 메모리나 작동 방식을 초기화하고 
접속된 사용자를 제어하기 위한 값을 별도로 저장해두는 데 이러한 값을 `시스템 변수(system variable)`라고 합니다.

```shell
SHOW GLOBAL VARIABLES;
```

<br>

## 글로벌 변수와 세션 변수

시스템 변수는 적용 범위에 따라 `글로벌 변수`와 `세션 변수`로 나뉩니다.

일반적으로 세션별로 적용되는 시스템 변수의 경우 글로벌 변수뿐만 아니라 세션 변수에도 동시에 존재합니다. (`Both`)

### 글로벌 변수

글로벌 변수는 하나의 서버 인스턴스에서 전체적으로 영향을 미치는 시스템 변수입니다.

주로 MYSQL 서버 자체 관련 설정이며 서버에 단 하나만 존재하는 InnoDB 버퍼 풀 크기(innodb_buffer_pool_size)나 
MyISAM의 키 캐시 크기(key_buffer_size) 등이 대표적입니다.

### 세션 변수

세션 변수는 클라이언트가 접속할 때마다 새로 생성되는 변수로 클라이언트가 접속할 때마다 새로운 값을 가지게 됩니다.

값을 변경하지 않은 경우 기본 값(글로벌 시스템 변수)이 그대로 유지되고 클라이언트 필요에 따라 개별 커넥션 단위로 다른 값으로 변경할 수 있습니다.

각 클라이언트에서 쿼리 단위로 자동 커밋을 할지 여부를 결정하는 autocommit 변수가 대표적인 예입니다.

한번 연결된 커넥션의 세션 변수는 서버에서 강제로 변경할 수 없습니다.

세션 변수 중에서 MYSQL 서버 설정 파일(my.cnf || my.ini)에 명시해 초기화할 수 있는 변수의 대부분의 범위가 Both 라고 명시되어있습니다.

Both로 명시된 시스템 변수는 MYSQL 서버가 기억만 하고있다가 커넥션이 연결되는 순간 해당 커넥션의 기본값으로 사용됩니다.

그러나 세션이라고 명시된 시스템 변수는 설정파일에 초기값을 명시할 수 없고 커넥션이 만들어 지는 순간부터 해당 커넥션에서만 유효한 설정 변수를 의미합니다.

<br>

## 정적 변수와 동적 변수

서버가 기동 중인 상태에서 변경이 가능한지에 따라 동적 변수와 정적 변수로 나뉩니다.

동적 변수는 `SET GLOBAL`을 사용하면 즉시 서버에 반영되는 변수이며 정적 변수는 서버가 재시작되어야만 변경이 가능한 변수입니다.

시스템 변수는 디스크에 저장되어 있는 설정 파일을 변경하는 경우와 기동중인 서버의 메모리에 있는 값을 변경하는 경우 두가지로 구분할 수 있습니다.

디스크에 저장된 설정파일의 내용은 변경하더라도 재시작까지 적용되지 않습니다.

`SHOW` 명령으로 서버에 적용된 변수값을 확인하거나 `SET`을 이용해 값을 변경할 수 있습니다. (`GLOBAL`을 붙이면 글로벌 시스템 변수의 목록을 선택하고 빼면 자동으로 세션 변수를 조회하고 변경합니다)

```shell
SHOW GLOBAL VARIABLES LIKE '%max_connections%';
```

| Variable_name | Value |
|---------------|-------|
| max_connections | 151   |
| mysqlx_max_connections | 100   |

```shell
SET GLOBAL max_connections = 200;
```

| Variable_name | Value |
|---------------|-------|
| max_connections | 200   |
| mysqlx_max_connections | 100   |

이때 SET 명령을 통해 변경되는 변수값이 설정파일에 반영되는것이 아니라서 기동중인 인스턴스에만 유효합니다. (재시작하면 초기화)

영구히 적용하고 싶으면 my.cnf 파일도 변경해야합니다. 

8.0부터는 `SET PERSIST` 명령을 사용하면 변수를 변경함과 동시에 자동으로 설정파일에도 반영됩니다.

이때 변경된 시스템 변수는 `my.cnf` 파일이 아닌 `mysqld-auto.cnf` 파일에 기록되빈다.

> 변수 범위가 Both(글로벌이면서 세션 변수의 경우)는 GLOBAL을 변경해도 이미 존재하는 커넥션의 세션 변수값은 변경되지 않고 그대로 유지됩니다.
> 변경 이후 새로 연결하는 커넥션에서 해당 값을 사용하게 됩니다.

### SET PERSIST

`SET PERSIST` 명령을 사용하면 변경된 값을 즉시 적용함과 동시에 설정파일(mysqld-auto.cnf)에 변경 내용을 추가로 기록해둡니다.

> 서버가 재시작될 때 기본 설정 파일 뿐만 아니라 자동 설정된 파일을 같이 참조해서 시스템 변수를 적용합니다.

`SET PERIST` 명령은 세션 변수에 적용되지 않으며 글로벌 시스템 변수의 변경으로 인식하고 변경합니다.

현재 실행중인 서버에 적용하지 않고 다음 재시작을 위해 파일에만 변경 기록을해둘려면 `SET PERSIST_ONLY` 명령을 사용하면 됩니다. 
이 명령은 정적인 변수의 값을 영구적으로 변경할 때도 사용할 수 있습니다.

```shell
SET PERSIST_ONLY innodb_doublewrite = ON;
```

`mysqld-auto.cnf` 파일에는 변경된 시스템 변수의 이름과 설정값 그리고 누구에 의해 변경되었는지 정보가 함꼐 기록됩니다.

### RESET PERSIST

`SET PERSIST`나 `SET PERSIST_ONLY` 명령으로 추가된 시스템 변수의 내용을 삭제할 때는 파일을 직접 변경하지 말고 `RESET PERSIST` 명령을 사용하는 것이 안전합니다.

```shell
RESET PERSIST max_connections;
RESET PERSIST IF EXISTS max_connections;

# 모든 시스템 변수를 초기화
RESET PERSIST;
```
